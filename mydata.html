<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Týdenní přehled - Stravovací deník</title>
  <meta name="description" content="Týdenní přehled zadaných stravovacích dat s detailními statistikami">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #17a2b8;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --info-color: #6f42c1;
      --light-color: #f8f9fa;
    }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      padding: 20px 0;
    }
    
    .main-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      max-width: 1400px;
      margin: 0 auto;
      overflow: hidden;
    }
    
    .header-section {
      background: linear-gradient(135deg, var(--primary-color), var(--info-color));
      color: white;
      padding: 2rem;
      text-align: center;
    }
    
    .stats-grid {
      padding: 2rem;
      background: var(--light-color);
    }
    
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border-left: 5px solid var(--primary-color);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .stat-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.8;
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .stat-label {
      color: var(--secondary-color);
      font-weight: 500;
    }
    
    .content-section {
      padding: 2rem;
    }
    
    .day-card {
      background: white;
      border-radius: 15px;
      margin-bottom: 2rem;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    
    .day-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .day-header {
      background: linear-gradient(135deg, #e9ecef, #f8f9fa);
      padding: 1.5rem;
      border-bottom: 2px solid #dee2e6;
    }
    
    .day-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary-color);
      margin: 0;
    }
    
    .day-summary {
      display: flex;
      gap: 2rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }
    
    .summary-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--secondary-color);
      font-size: 0.9rem;
    }
    
    .meal-section {
      padding: 1.5rem;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .meal-section:last-child {
      border-bottom: none;
    }
    
    .meal-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .meal-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--success-color);
      margin: 0;
    }
    
    .meal-calories {
      background: var(--success-color);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .food-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px dotted #dee2e6;
    }
    
    .food-item:last-child {
      border-bottom: none;
    }
    
    .food-name {
      font-weight: 500;
      flex: 1;
    }
    
    .food-details {
      display: flex;
      gap: 1rem;
      color: var(--secondary-color);
      font-size: 0.9rem;
    }
    
    .summary-section {
      background: var(--light-color);
      padding: 2rem;
    }
    
    .summary-table {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .summary-table th {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
      padding: 1rem;
      border: none;
    }
    
    .summary-table td {
      padding: 1rem;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
    }
    
    .progress-container {
      width: 120px;
    }
    
    .progress {
      height: 20px;
      border-radius: 10px;
      background: #e9ecef;
    }
    
    .progress-bar {
      border-radius: 10px;
      transition: width 0.6s ease;
    }
    
    .loading-section {
      text-align: center;
      padding: 4rem 2rem;
    }
    
    .loading-spinner {
      width: 4rem;
      height: 4rem;
      color: var(--primary-color);
    }
    
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--secondary-color);
    }
    
    .empty-icon {
      font-size: 4rem;
      opacity: 0.5;
      margin-bottom: 2rem;
    }
    
    .back-button {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      border-radius: 25px;
      padding: 0.75rem 2rem;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .back-button:hover {
      background: rgba(255, 255, 255, 0.3);
      color: white;
      transform: translateY(-2px);
    }
    
    /* Responzivní design */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .main-container {
        margin: 0 10px;
        border-radius: 15px;
      }
      
      .stats-grid,
      .content-section,
      .summary-section {
        padding: 1rem;
      }
      
      .stat-card {
        padding: 1.5rem 1rem;
      }
      
      .stat-number {
        font-size: 2rem;
      }
      
      .day-summary {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .food-details {
        flex-direction: column;
        gap: 0.25rem;
        text-align: right;
      }
      
      .progress-container {
        width: 100px;
      }
    }
    
    /* Animace */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .day-card {
      animation: fadeInUp 0.6s ease-out;
    }
    
    .stat-card {
      animation: fadeInUp 0.6s ease-out;
    }
  </style>
</head>

<body>
  <div class="main-container">
    <!-- Hlavička -->
    <div class="header-section">
      <h1><i class="bi bi-graph-up me-2"></i>Týdenní přehled stravy</h1>
      <p class="mb-3 opacity-90">Detailní analýza vašich stravovacích dat</p>
      <div class="client-info mb-3" id="client-info">
        <i class="bi bi-person-circle me-1"></i>
        <span id="client-name">Načítám...</span>
      </div>
      <a href="#" id="back-link" class="back-button">
        <i class="bi bi-arrow-left me-2"></i>Zpět na formulář
      </a>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading-section">
      <div class="loading-spinner spinner-border" role="status">
        <span class="visually-hidden">Načítám...</span>
      </div>
      <h4 class="mt-3">Načítám data...</h4>
      <p class="text-muted">Prosím počkejte, zpracovávám váš týdenní přehled</p>
    </div>

    <!-- Statistiky -->
    <div id="statistics" class="stats-grid d-none">
      <div class="row g-4">
        <div class="col-lg-3 col-md-6">
          <div class="stat-card">
            <div class="stat-icon text-warning">
              <i class="bi bi-calendar-week"></i>
            </div>
            <div class="stat-number text-warning" id="days-with-data">0</div>
            <div class="stat-label">Dní s daty</div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="stat-card">
            <div class="stat-icon text-success">
              <i class="bi bi-list-ul"></i>
            </div>
            <div class="stat-number text-success" id="total-items">0</div>
            <div class="stat-label">Celkem položek</div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="stat-card">
            <div class="stat-icon text-danger">
              <i class="bi bi-fire"></i>
            </div>
            <div class="stat-number text-danger" id="total-calories">0</div>
            <div class="stat-label">Celkem kalorií</div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="stat-card">
            <div class="stat-icon text-info">
              <i class="bi bi-calculator"></i>
            </div>
            <div class="stat-number text-info" id="avg-calories">0</div>
            <div class="stat-label">Průměr/den</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Denní přehled -->
    <div id="daily-data" class="content-section d-none">
      <h3 class="text-center mb-4">
        <i class="bi bi-calendar3 me-2"></i>
        Detailní přehled podle dnů
      </h3>
      <div id="days-container">
        <!-- Zde se vloží denní data -->
      </div>
    </div>

    <!-- Souhrn podle chodu -->
    <div id="meal-summary" class="summary-section d-none">
      <h3 class="text-center mb-4">
        <i class="bi bi-pie-chart me-2"></i>
        Souhrn podle chodu jídla
      </h3>
      <div class="summary-table">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Chod jídla</th>
              <th>Počet položek</th>
              <th>Celkem kalorií</th>
              <th>Průměr/den</th>
              <th>Podíl (%)</th>
              <th>Vizualizace</th>
            </tr>
          </thead>
          <tbody id="meal-summary-body">
            <!-- Zde se vloží souhrn podle chodu -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Prázdný stav -->
    <div id="empty-state" class="empty-state d-none">
      <div class="empty-icon">
        <i class="bi bi-inbox"></i>
      </div>
      <h3>Žádná data za posledních 7 dní</h3>
      <p class="mb-4">
        Začněte zadávat svůj stravovací deník pomocí formuláře.<br>
        Data se zde zobrazí automaticky po jejich zadání.
      </p>
      <a href="#" id="back-link-empty" class="btn btn-primary btn-lg">
        <i class="bi bi-plus-lg me-2"></i>Přidat první záznam
      </a>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===== KONFIGURACE =====
    const CONFIG = {
      API_URL: 'https://script.google.com/macros/s/AKfycby_EAwyBCmVhRsO59AEeS6ybRPCkXeHXHBhL3t4CgpOH46LnQA2806dvc-mpnLgawbQ/exec', // ⚠️ MUSÍŠ NAHRADIT!
      DAYS_TO_SHOW: 7,
      DEBUG: false
    };

    // ===== GLOBÁLNÍ PROMĚNNÉ =====
    let currentClientKey = '';
    let weekData = [];
    let processedStats = {};

    // ===== INICIALIZACE =====
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    function initializeApp() {
      // Získání klientského klíče z URL
      const urlParams = new URLSearchParams(window.location.search);
      currentClientKey = urlParams.get('key') || 'demo';
      
      // Nastavení UI
      setupUI();
      
      // Načtení dat
      loadWeekData();
    }

    function setupUI() {
      document.getElementById('client-name').textContent = `Klient: ${currentClientKey} • Posledních ${CONFIG.DAYS_TO_SHOW} dní`;
      document.getElementById('back-link').href = `index.html?key=${currentClientKey}`;
      document.getElementById('back-link-empty').href = `index.html?key=${currentClientKey}`;
    }

    async function loadWeekData() {
      try {
        if (CONFIG.DEBUG) {
          console.log('Načítám data pro klienta:', currentClientKey);
        }

        const response = await fetch(`${CONFIG.API_URL}?key=${currentClientKey}&days=${CONFIG.DAYS_TO_SHOW}`);
        
        if (!response.ok) {
          throw new Error(`HTTP chyba: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          weekData = result.data || [];
          processData();
          displayData();
        } else {
          throw new Error(result.error || 'Neznámá chyba serveru');
        }

      } catch (error) {
        console.error('Chyba při načítání dat:', error);
        showError(`Chyba při načítání dat: ${error.message}`);
      } finally {
        document.getElementById('loading').classList.add('d-none');
      }
    }

    function processData() {
      if (weekData.length === 0) {
        return;
      }

      // Základní statistiky
      const uniqueDays = new Set(weekData.map(item => item.datum));
      const totalCalories = weekData.reduce((sum, item) => sum + (parseFloat(item.kaloricka_hodnota) || 0), 0);
      const avgCalories = uniqueDays.size > 0 ? totalCalories / uniqueDays.size : 0;

      processedStats = {
        daysWithData: uniqueDays.size,
        totalItems: weekData.length,
        totalCalories: totalCalories,
        avgCalories: avgCalories
      };

      if (CONFIG.DEBUG) {
        console.log('Zpracované statistiky:', processedStats);
      }
    }

    function displayData() {
      if (weekData.length === 0) {
        document.getElementById('empty-state').classList.remove('d-none');
        return;
      }

      // Zobrazit všechny sekce
      document.getElementById('statistics').classList.remove('d-none');
      document.getElementById('daily-data').classList.remove('d-none');
      document.getElementById('meal-summary').classList.remove('d-none');

      // Naplnit data
      displayStatistics();
      displayDailyData();
      displayMealSummary();
    }

    function displayStatistics() {
      document.getElementById('days-with-data').textContent = processedStats.daysWithData;
      document.getElementById('total-items').textContent = processedStats.totalItems.toLocaleString();
      document.getElementById('total-calories').textContent = Math.round(processedStats.totalCalories).toLocaleString();
      document.getElementById('avg-calories').textContent = Math.round(processedStats.avgCalories).toLocaleString();
    }

    function displayDailyData() {
      const container = document.getElementById('days-container');
      container.innerHTML = '';

      // Seskupení podle data
      const dayGroups = groupDataByDay();
      
      // Seřazení podle data (nejnovější první)
      const sortedDates = Object.keys(dayGroups).sort((a, b) => new Date(b) - new Date(a));

      sortedDates.forEach((date, index) => {
        const dayCard = createDayCard(date, dayGroups[date], index);
        container.appendChild(dayCard);
      });
    }

    function groupDataByDay() {
      const dayGroups = {};

      weekData.forEach(item => {
        const date = item.datum;
        if (!dayGroups[date]) {
          dayGroups[date] = {};
        }

        const meal = item.druh_chodu;
        if (!dayGroups[date][meal]) {
          dayGroups[date][meal] = [];
        }

        dayGroups[date][meal].push(item);
      });

      return dayGroups;
    }

    function createDayCard(date, dayData, index) {
      const dayCard = document.createElement('div');
      dayCard.className = 'day-card';
      dayCard.style.animationDelay = `${index * 0.1}s`;

      // Výpočet celkových kalorií pro den
      const dayTotalCalories = Object.values(dayData)
        .flat()
        .reduce((sum, item) => sum + (parseFloat(item.kaloricka_hodnota) || 0), 0);

      // Počet položek pro den  
      const dayTotalItems = Object.values(dayData).flat().length;

      dayCard.innerHTML = `
        <div class="day-header">
          <div class="day-title">
            <i class="bi bi-calendar3 me-2"></i>
            ${formatDateHeader(date)}
          </div>
          <div class="day-summary">
            <div class="summary-item">
              <i class="bi bi-list-ul"></i>
              <span>${dayTotalItems} položek</span>
            </div>
            <div class="summary-item">
              <i class="bi bi-fire"></i>
              <span>${Math.round(dayTotalCalories)} kcal</span>
            </div>
            <div class="summary-item">
              <i class="bi bi-clock"></i>
              <span>${Object.keys(dayData).length} chodů</span>
            </div>
          </div>
        </div>
      `;

      // Přidání chodů jídla
      const mealOrder = ['Snídaně', 'Svačina dopoledne', 'Oběd', 'Svačina odpoledne', 'Večeře', 'Jiný příjem', 'Pitný režim'];
      
      mealOrder.forEach(mealType => {
        if (dayData[mealType]) {
          const mealSection = createMealSection(mealType, dayData[mealType]);
          dayCard.appendChild(mealSection);
        }
      });

      return dayCard;
    }

    function createMealSection(mealType, mealItems) {
      const mealSection = document.createElement('div');
      mealSection.className = 'meal-section';

      const mealCalories = mealItems.reduce((sum, item) => sum + (parseFloat(item.kaloricka_hodnota) || 0), 0);

      mealSection.innerHTML = `
        <div class="meal-header">
          <h5 class="meal-title">
            <i class="bi bi-arrow-right-circle me-2"></i>
            ${mealType}
          </h5>
          <div class="meal-calories">
            ${Math.round(mealCalories)} kcal
          </div>
        </div>
      `;

      // Přidání jednotlivých položek
      mealItems.forEach(item => {
        const foodItem = document.createElement('div');
        foodItem.className = 'food-item';
        foodItem.innerHTML = `
          <div class="food-name">
            <strong>${item.potravina}</strong>
          </div>
          <div class="food-details">
            <span><i class="bi bi-arrows-expand me-1"></i>${item.hmotnost}g</span>
            <span><i class="bi bi-fire me-1"></i>${item.kaloricka_hodnota || 0} kcal</span>
          </div>
        `;
        mealSection.appendChild(foodItem);
      });

      return mealSection;
    }

    function displayMealSummary() {
      const tbody = document.getElementById('meal-summary-body');
      tbody.innerHTML = '';

      // Seskupení podle chodu jídla
      const mealGroups = {};
      let totalCalories = 0;

      weekData.forEach(item => {
        const meal = item.druh_chodu;
        const calories = parseFloat(item.kaloricka_hodnota) || 0;

        if (!mealGroups[meal]) {
          mealGroups[meal] = { count: 0, calories: 0 };
        }

        mealGroups[meal].count++;
        mealGroups[meal].calories += calories;
        totalCalories += calories;
      });

      const uniqueDays = new Set(weekData.map(item => item.datum)).size;

      // Seřazení podle počtu kalorií
      const sortedMeals = Object.entries(mealGroups)
        .sort(([,a], [,b]) => b.calories - a.calories);

      sortedMeals.forEach(([meal, data]) => {
        const percentage = totalCalories > 0 ? (data.calories / totalCalories * 100) : 0;
        const avgPerDay = uniqueDays > 0 ? data.calories / uniqueDays : 0;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <strong>${meal}</strong>
          </td>
          <td>
            <span class="badge bg-secondary rounded-pill">${data.count}</span>
          </td>
          <td>
            <strong>${Math.round(data.calories).toLocaleString()} kcal</strong>
          </td>
          <td>
            ${Math.round(avgPerDay).toLocaleString()} kcal
          </td>
          <td>
            <strong>${Math.round(percentage)}%</strong>
          </td>
          <td>
            <div class="progress-container">
              <div class="progress">
                <div class="progress-bar bg-${getProgressBarColor(percentage)}" 
                     role="progressbar" 
                     style="width: ${percentage}%" 
                     aria-valuenow="${percentage}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                </div>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function getProgressBarColor(percentage) {
      if (percentage >= 30) return 'danger';
      if (percentage >= 20) return 'warning';
      if (percentage >= 10) return 'info';
      return 'success';
    }

    function formatDateHeader(dateString) {
      const date = new Date(dateString + 'T00:00:00');
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      // Normalizace na začátek dne
      today.setHours(0, 0, 0, 0);
      yesterday.setHours(0, 0, 0, 0);
      date.setHours(0, 0, 0, 0);

      if (date.getTime() === today.getTime()) {
        return `Dnes (${date.toLocaleDateString('cs-CZ')})`;
      } else if (date.getTime() === yesterday.getTime()) {
        return `Včera (${date.toLocaleDateString('cs-CZ')})`;
      } else {
        const options = { 
          weekday: 'long', 
          day: 'numeric', 
          month: 'long',
          year: 'numeric'
        };
        return date.toLocaleDateString('cs-CZ', options);
      }
    }

    function showError(message) {
      const loadingSection = document.getElementById('loading');
      loadingSection.innerHTML = `
        <div class="text-danger">
          <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
          <h4>Chyba při načítání</h4>
          <p>${message}</p>
          <button class="btn btn-primary" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise me-2"></i>Zkusit znovu
          </button>
        </div>
      `;
    }

    // ===== VALIDACE API URL =====
    if (CONFIG.API_URL === 'https://script.google.com/macros/s/AKfycby_EAwyBCmVhRsO59AEeS6ybRPCkXeHXHBhL3t4CgpOH46LnQA2806dvc-mpnLgawbQ/exec') {
      document.addEventListener('DOMContentLoaded', function() {
        showError('⚠️ Aplikace není nakonfigurována! Prosím nastavte API_URL v kódu.');
      });
    }
  </script>
</body>
</html>
