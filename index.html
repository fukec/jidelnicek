<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stravovac√≠ den√≠k - Zad√°n√≠</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    :root {
      --primary-color: #28a745;
      --success-color: #20c997;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      padding: 20px 0;
    }

    .main-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      max-width: 1000px;
      margin: 0 auto;
      overflow: hidden;
    }

    .header-section {
      background: linear-gradient(135deg, var(--primary-color), var(--success-color));
      color: white;
      padding: 2rem;
      text-align: center;
    }

    .form-section { padding: 2rem; }
    .date-section { background: #f8f9fa; border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem; }
    .entry-card { background: white; border: 2px solid #e9ecef; border-radius: 15px; padding: 1.5rem; margin-bottom: 1rem; position: relative; }
    .entry-number { position: absolute; top: -10px; right: -10px; background: var(--primary-color); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .form-control, .form-select { border: 2px solid #e9ecef; border-radius: 10px; padding: 0.75rem; }
    .btn { border-radius: 10px; padding: 0.75rem 1.5rem; font-weight: 600; }
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .loading-content { background: white; padding: 2rem; border-radius: 15px; text-align: center; }
    .debug-info { background: #f8f9fa; border: 1px solid #e9ecef; padding: 1rem; margin: 1rem 0; font-family: monospace; font-size: 0.9rem; }
  </style>
</head>

<body>
  <div class="container">
    <div class="main-container">
      
      <div class="header-section">
        <h1><i class="bi bi-egg-fried me-3"></i>Stravovac√≠ den√≠k</h1>
        <div class="client-info" id="client-name">Naƒç√≠t√°m...</div>
      </div>

      <div class="form-section">
        
        <div id="result" class="alert d-none" role="alert"></div>
        
        <div class="date-section">
          <h4><i class="bi bi-calendar3 me-2"></i>Datum z√°znamu</h4>
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label for="datum" class="form-label fw-semibold">Datum</label>
              <input type="date" class="form-control" id="datum" required>
            </div>
            <div class="col-md-8">
              <button type="button" class="btn btn-outline-success me-2" id="today-btn">Dnes</button>
              <button type="button" class="btn btn-outline-info me-2" id="yesterday-btn">Vƒçera</button>
              <button type="button" class="btn btn-outline-danger" id="clear-form-btn">Vymazat</button>
            </div>
          </div>
        </div>

        <form id="food-form" novalidate>
          
          <h4><i class="bi bi-list-ul me-2"></i>Polo≈æky stravy <span class="badge bg-info" id="items-counter">0 polo≈æek</span></h4>
          
          <div id="entries" class="mb-4"></div>
          
          <div class="text-center mb-4">
            <button type="button" class="btn btn-success btn-lg" id="add-item-btn">
              <i class="bi bi-plus-circle me-2"></i>P≈ôidat polo≈æku
            </button>
          </div>
          
          <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
              <i class="bi bi-send me-2"></i>Odeslat den√≠k
            </button>
          </div>
          
        </form>

        <div id="debug-info" class="debug-info"></div>
      </div>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay d-none">
    <div class="loading-content">
      <div class="spinner-border text-primary mb-3" role="status"></div>
      <h5>Ukl√°d√°m data...</h5>
      <p class="text-muted mb-0">Pros√≠m poƒçkejte</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===== KONFIGURACE =====
    const CONFIG = {
      API_URL: "https://script.google.com/macros/s/AKfycbyTIXx1yUgfd5-ZIYHQVBF_GIZs3VNkNR-k7dZ7nrkj91h-S1uOl5wW3g3tiHKOtNyb/exec", // ‚ö†Ô∏è NAHRAƒé SVOJ√ç URL!
      MEALS: ["Sn√≠danƒõ", "Svaƒçina dopoledne", "Obƒõd", "Svaƒçina odpoledne", "Veƒçe≈ôe", "Jin√Ω p≈ô√≠jem", "Pitn√Ω re≈æim"],
      MAX_ITEMS: 40,
      DEBUG: false
    };

    let currentClientKey = "";
    let itemCounter = 0;

    // ===== INICIALIZACE =====
    document.addEventListener("DOMContentLoaded", function () {
      initializeApp();
    });

    function initializeApp() {
      const urlParams = new URLSearchParams(window.location.search);
      currentClientKey = urlParams.get("key") || "demo123";
      
      document.getElementById("client-name").textContent = `Klient: ${currentClientKey}`;
      document.getElementById("datum").value = new Date().toISOString().split("T")[0];
      
      setupEventListeners();
      addFoodItem();
      
      if (CONFIG.DEBUG) {
        showDebugInfo();
      }
    }

    function showDebugInfo() {
      document.getElementById("debug-info").innerHTML = `
        <strong>üîß DEBUG INFO:</strong><br>
        Klient: ${currentClientKey}<br>
        API URL: ${CONFIG.API_URL}<br>
        Status: ${CONFIG.API_URL.includes('YOUR_SCRIPT_ID') ? '‚ùå MUS√ç≈† NASTAVIT URL!' : '‚úÖ URL nastavena'}<br>
        Timestamp: ${new Date().toISOString()}
      `;
    }

    function setupEventListeners() {
      document.getElementById("food-form").addEventListener("submit", handleFormSubmit);
      document.getElementById("add-item-btn").addEventListener("click", addFoodItem);
      document.getElementById("clear-form-btn").addEventListener("click", clearForm);
      document.getElementById("today-btn").addEventListener("click", () => setDate(0));
      document.getElementById("yesterday-btn").addEventListener("click", () => setDate(-1));
    }

    function addFoodItem() {
      if (itemCounter >= CONFIG.MAX_ITEMS) {
        showAlert(`Maximum ${CONFIG.MAX_ITEMS} polo≈æek`, "warning");
        return;
      }
      
      itemCounter++;
      const entriesContainer = document.getElementById("entries");
      const entryCard = document.createElement("div");
      entryCard.className = "entry-card";
      entryCard.setAttribute("data-item-id", itemCounter);
      
      entryCard.innerHTML = `
        <div class="entry-number">${itemCounter}</div>
        <div class="row g-3">
          <div class="col-lg-3">
            <label class="form-label fw-semibold">Druh chodu</label>
            <select class="form-select" name="druh_chodu" required>
              <option value="">Vyberte chod</option>
              ${CONFIG.MEALS.map(meal => `<option value="${meal}">${meal}</option>`).join("")}
            </select>
          </div>
          <div class="col-lg-2">
            <label class="form-label fw-semibold">Hmotnost (g/ml)</label>
            <input type="number" class="form-control" name="hmotnost" min="0.1" max="10000" step="0.1" required />
          </div>
          <div class="col-lg-4">
            <label class="form-label fw-semibold">Potravina</label>
            <input type="text" class="form-control" name="potravina" maxlength="100" required />
          </div>
          <div class="col-lg-2">
            <label class="form-label fw-semibold">Kalorie (kcal)</label>
            <input type="number" class="form-control" name="kaloricka_hodnota" min="0" max="9999" step="1" />
          </div>
          <div class="col-lg-1">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-outline-danger w-100" onclick="removeFoodItem(this)">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      `;
      
      entriesContainer.appendChild(entryCard);
      updateItemsCounter();
    }

    function removeFoodItem(button) {
      if (document.querySelectorAll(".entry-card").length <= 1) {
        showAlert("Mus√≠ z≈Østat alespo≈à jedna polo≈æka!", "warning");
        return;
      }
      button.closest(".entry-card").remove();
      updateEntryNumbers();
      updateItemsCounter();
    }

    function updateEntryNumbers() {
      const entryCards = document.querySelectorAll(".entry-card");
      entryCards.forEach((card, index) => {
        const numberElement = card.querySelector(".entry-number");
        if (numberElement) numberElement.textContent = index + 1;
        card.setAttribute("data-item-id", index + 1);
      });
      itemCounter = entryCards.length;
    }

    function updateItemsCounter() {
      const count = document.querySelectorAll(".entry-card").length;
      document.getElementById("items-counter").textContent = `${count} polo≈æek`;
    }

    function setDate(daysOffset) {
      const date = new Date();
      date.setDate(date.getDate() + daysOffset);
      document.getElementById("datum").value = date.toISOString().split("T")[0];
    }

    function clearForm() {
      if (!confirm("Opravdu chcete vymazat v≈°echny polo≈æky?")) return;
      document.getElementById("entries").innerHTML = "";
      itemCounter = 0;
      addFoodItem();
      document.getElementById("result").classList.add("d-none");
    }

    async function handleFormSubmit(event) {
      event.preventDefault();
      
      if (CONFIG.API_URL.includes('YOUR_SCRIPT_ID')) {
        showAlert("‚ùå MUS√ç≈† NASTAVIT API_URL v k√≥du! Nahraƒè YOUR_SCRIPT_ID_HERE svou Google Apps Script URL.", "danger");
        return;
      }
      
      const formData = gatherFormData();
      if (!formData) return;
      await submitData(formData);
    }

    function gatherFormData() {
      const datum = document.getElementById("datum").value;
      if (!datum) {
        showAlert("Vyberte datum", "danger");
        return null;
      }
      
      const items = [];
      document.querySelectorAll(".entry-card").forEach((card) => {
        const druh_chodu = card.querySelector("select[name='druh_chodu']").value;
        const hmotnost = card.querySelector("input[name='hmotnost']").value;
        const potravina = card.querySelector("input[name='potravina']").value.trim();
        const kaloricka_hodnota = card.querySelector("input[name='kaloricka_hodnota']").value;
        
        if (potravina && hmotnost && parseFloat(hmotnost) > 0 && druh_chodu) {
          items.push({
            datum: datum,
            druh_chodu: druh_chodu,
            hmotnost: parseFloat(hmotnost),
            potravina: potravina,
            kaloricka_hodnota: parseFloat(kaloricka_hodnota) || 0,
          });
        }
      });
      
      if (items.length === 0) {
        showAlert("≈Ω√°dn√© platn√© polo≈æky k odesl√°n√≠!", "warning");
        return null;
      }
      
      return {
        klient_klic: currentClientKey,
        items: items,
      };
    }

    async function submitData(data) {
      const loadingOverlay = document.getElementById("loading-overlay");
      const submitBtn = document.getElementById("submit-btn");
      
      try {
        loadingOverlay.classList.remove("d-none");
        submitBtn.disabled = true;
        
        if (CONFIG.DEBUG) {
          console.log("üöÄ Odes√≠l√°m data:", data);
          console.log("üîó URL:", CONFIG.API_URL);
        }

        // KRITICK√â NASTAVEN√ç PRO GOOGLE APPS SCRIPT
        const response = await fetch(CONFIG.API_URL, {
          method: "POST",
          redirect: "follow",
          headers: { 
            "Content-Type": "text/plain;charset=utf-8"
          },
          body: JSON.stringify(data)
        });

        if (CONFIG.DEBUG) {
          console.log("üì° Response status:", response.status);
          console.log("üîó Response URL:", response.url);
        }

        const responseText = await response.text();
        
        if (CONFIG.DEBUG) {
          console.log("üìÑ Raw response:", responseText);
        }

        let result;
        try {
          result = JSON.parse(responseText);
        } catch (parseError) {
          console.error("‚ùå JSON parse error:", parseError);
          throw new Error("Server nevr√°til platn√Ω JSON. Zkontroluj Google Apps Script deployment.");
        }

        if (CONFIG.DEBUG) {
          console.log("‚úÖ Parsed result:", result);
        }

        if (result.success) {
          showAlert(`‚úÖ √öspƒõ≈°nƒõ odesl√°no ${data.items.length} polo≈æek!`, "success");
          setTimeout(() => clearForm(), 2000);
        } else {
          throw new Error(result.error || "Nezn√°m√° chyba serveru");
        }
        
      } catch (error) {
        console.error("‚ùå Chyba p≈ôi odes√≠l√°n√≠:", error);
        
        let errorMessage = error.message;
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage = "Chyba s√≠tƒõ nebo ≈°patn√° URL. Zkontroluj Google Apps Script deployment.";
        }
        
        showAlert(`‚ùå Chyba: ${errorMessage}`, "danger");
      } finally {
        loadingOverlay.classList.add("d-none");
        submitBtn.disabled = false;
      }
    }

    function showAlert(message, type) {
      const result = document.getElementById("result");
      result.className = `alert alert-${type}`;
      result.innerHTML = message;
      result.classList.remove("d-none");
      result.scrollIntoView({ behavior: "smooth" });
      
      if (type === "success") {
        setTimeout(() => result.classList.add("d-none"), 5000);
      }
    }

    // Global function for remove button
    window.removeFoodItem = removeFoodItem;
  </script>
</body>
</html>
