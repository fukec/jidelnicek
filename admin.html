<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Stravovací deník</title>
  <meta name="description" content="Administrátorské rozhraní pro správu a export stravovacích dat">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #dc3545;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --info-color: #17a2b8;
      --warning-color: #ffc107;
      --danger-color: #fd7e14;
      --dark-color: #343a40;
      --light-color: #f8f9fa;
    }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    
    .admin-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      min-height: 100vh;
    }
    
    .header-section {
      background: linear-gradient(135deg, var(--primary-color), var(--danger-color));
      color: white;
      padding: 2rem 0;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .main-content {
      padding: 2rem;
    }
    
    .stats-overview {
      margin-bottom: 3rem;
    }
    
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border-left: 5px solid var(--primary-color);
      height: 100%;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .stat-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.8;
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .stat-label {
      color: var(--secondary-color);
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .control-panel {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .data-table-container {
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .table-header {
      background: linear-gradient(135deg, var(--dark-color), #495057);
      color: white;
      padding: 1.5rem;
    }
    
    .data-table {
      margin-bottom: 0;
    }
    
    .data-table th {
      background: var(--light-color);
      color: var(--dark-color);
      font-weight: 600;
      padding: 1rem;
      border-bottom: 2px solid #dee2e6;
    }
    
    .data-table td {
      padding: 0.75rem 1rem;
      vertical-align: middle;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .data-table tbody tr:hover {
      background-color: rgba(220, 53, 69, 0.05);
    }
    
    .filter-section {
      background: var(--light-color);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    .export-section {
      background: linear-gradient(135deg, #e9ecef, #f8f9fa);
      border-radius: 15px;
      padding: 2rem;
      border: 2px dashed #dee2e6;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--danger-color));
      border: none;
      border-radius: 25px;
      padding: 0.75rem 2rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
    }
    
    .btn-success {
      border-radius: 25px;
      padding: 0.75rem 2rem;
      font-weight: 500;
    }
    
    .btn-outline-secondary {
      border-radius: 25px;
      border-width: 2px;
    }
    
    .form-control, .form-select {
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.15);
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(5px);
    }
    
    .loading-content {
      background: white;
      border-radius: 20px;
      padding: 3rem;
      text-align: center;
      max-width: 400px;
    }
    
    .spinner-border {
      width: 3rem;
      height: 3rem;
      color: var(--primary-color);
    }
    
    .alert {
      border-radius: 15px;
      border: none;
      padding: 1rem 1.5rem;
    }
    
    .badge {
      font-size: 0.8rem;
      padding: 0.5rem 0.75rem;
    }
    
    .client-badge {
      background: linear-gradient(135deg, var(--info-color), #20c997);
      color: white;
      border-radius: 15px;
    }
    
    .meal-badge {
      background: linear-gradient(135deg, var(--success-color), #20c997);
      color: white;
      border-radius: 10px;
    }
    
    .activity-section {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .activity-item {
      display: flex;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary-color), var(--danger-color));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 1rem;
      flex-shrink: 0;
    }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-time {
      color: var(--secondary-color);
      font-size: 0.85rem;
    }
    
    .pagination-container {
      background: white;
      padding: 1.5rem;
      border-radius: 0 0 20px 20px;
      border-top: 1px solid #dee2e6;
    }
    
    /* Responzivní design */
    @media (max-width: 768px) {
      .main-content {
        padding: 1rem;
      }
      
      .stat-card {
        padding: 1.5rem 1rem;
        margin-bottom: 1rem;
      }
      
      .stat-number {
        font-size: 2rem;
      }
      
      .control-panel,
      .activity-section {
        padding: 1rem;
      }
      
      .filter-section,
      .export-section {
        padding: 1rem;
      }
      
      .btn {
        width: 100%;
        margin-bottom: 0.5rem;
      }
      
      .table-responsive {
        border-radius: 15px;
      }
    }
    
    /* Animace */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .stat-card,
    .control-panel,
    .activity-section,
    .data-table-container {
      animation: fadeInUp 0.6s ease-out;
    }
    
    /* Utility třídy */
    .text-gradient {
      background: linear-gradient(135deg, var(--primary-color), var(--danger-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .border-gradient {
      border: 3px solid;
      border-image: linear-gradient(135deg, var(--primary-color), var(--danger-color));
      border-image-slice: 1;
    }
  </style>
</head>

<body>
  <div class="admin-container">
    <!-- Hlavička -->
    <div class="header-section">
      <div class="container">
        <div class="text-center">
          <h1 class="display-5 fw-bold">
            <i class="bi bi-shield-check me-3"></i>
            Admin Panel
          </h1>
          <p class="lead mb-0">Správa stravovacího deníku a export dat</p>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="container-fluid">
        <!-- Celkové statistiky -->
        <div class="stats-overview">
          <div class="row g-4">
            <div class="col-xl-3 col-lg-6">
              <div class="stat-card">
                <div class="stat-icon text-warning">
                  <i class="bi bi-people"></i>
                </div>
                <div class="stat-number text-warning" id="total-clients">0</div>
                <div class="stat-label">Aktivní klienti<br><small>(za 30 dní)</small></div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6">
              <div class="stat-card">
                <div class="stat-icon text-success">
                  <i class="bi bi-list-ul"></i>
                </div>
                <div class="stat-number text-success" id="total-records">0</div>
                <div class="stat-label">Celkem záznamů<br><small>(všechny časy)</small></div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6">
              <div class="stat-card">
                <div class="stat-icon text-info">
                  <i class="bi bi-calendar-day"></i>
                </div>
                <div class="stat-number text-info" id="today-records">0</div>
                <div class="stat-label">Dnešní záznamy<br><small>(nové dnes)</small></div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6">
              <div class="stat-card">
                <div class="stat-icon text-danger">
                  <i class="bi bi-graph-up"></i>
                </div>
                <div class="stat-number text-danger" id="avg-daily">0</div>
                <div class="stat-label">Průměr za den<br><small>(posledních 7 dní)</small></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ovládací panel -->
        <div class="control-panel">
          <h4 class="text-gradient mb-4">
            <i class="bi bi-funnel me-2"></i>Filtry a export dat
          </h4>
          
          <!-- Filtry -->
          <div class="filter-section">
            <div class="row g-3">
              <div class="col-lg-3 col-md-6">
                <label for="filter-client" class="form-label fw-semibold">
                  <i class="bi bi-person me-1"></i>Klient
                </label>
                <select id="filter-client" class="form-select">
                  <option value="">Všichni klienti</option>
                </select>
              </div>
              <div class="col-lg-3 col-md-6">
                <label for="filter-date-from" class="form-label fw-semibold">
                  <i class="bi bi-calendar3 me-1"></i>Od data
                </label>
                <input type="date" id="filter-date-from" class="form-control">
              </div>
              <div class="col-lg-3 col-md-6">
                <label for="filter-date-to" class="form-label fw-semibold">
                  <i class="bi bi-calendar3 me-1"></i>Do data
                </label>
                <input type="date" id="filter-date-to" class="form-control">
              </div>
              <div class="col-lg-3 col-md-6 d-flex align-items-end">
                <div class="w-100">
                  <button type="button" class="btn btn-primary w-100" id="apply-filters-btn">
                    <i class="bi bi-search me-2"></i>Filtrovat
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Export sekce -->
          <div class="export-section">
            <h5 class="mb-3">
              <i class="bi bi-download me-2"></i>Export a akce
            </h5>
            <div class="row g-2">
              <div class="col-lg-2 col-md-4 col-sm-6">
                <button type="button" class="btn btn-success w-100" id="export-csv-btn">
                  <i class="bi bi-file-spreadsheet me-1"></i>CSV
                </button>
              </div>
              <div class="col-lg-2 col-md-4 col-sm-6">
                <button type="button" class="btn btn-info w-100" id="export-excel-btn">
                  <i class="bi bi-file-excel me-1"></i>Excel
                </button>
              </div>
              <div class="col-lg-2 col-md-4 col-sm-6">
                <button type="button" class="btn btn-warning w-100" id="generate-report-btn">
                  <i class="bi bi-file-text me-1"></i>Report
                </button>
              </div>
              <div class="col-lg-2 col-md-4 col-sm-6">
                <button type="button" class="btn btn-secondary w-100" id="clear-filters-btn">
                  <i class="bi bi-x-circle me-1"></i>Reset
                </button>
              </div>
              <div class="col-lg-2 col-md-4 col-sm-6">
                <button type="button" class="btn btn-outline-secondary w-100" id="refresh-btn">
                  <i class="bi bi-arrow-clockwise me-1"></i>Obnovit
                </button>
              </div>
              <div class="col-lg-2 col-md-4 col-sm-6">
                <a href="index.html" class="btn btn-outline-primary w-100">
                  <i class="bi bi-house me-1"></i>Domů
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabulka dat -->
        <div class="data-table-container">
          <div class="table-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
              <i class="bi bi-table me-2"></i>Data z formulářů
            </h4>
            <span id="records-count" class="badge bg-light text-dark fs-6">
              Načítám...
            </span>
          </div>
          
          <!-- Loading -->
          <div id="loading" class="text-center p-5">
            <div class="spinner-border mb-3" role="status">
              <span class="visually-hidden">Načítám...</span>
            </div>
            <h5>Načítám data...</h5>
            <p class="text-muted">Prosím počkejte</p>
          </div>
          
          <!-- Tabulka -->
          <div id="data-container" class="d-none">
            <div class="table-responsive">
              <table class="table data-table">
                <thead>
                  <tr>
                    <th>Datum</th>
                    <th>Klient</th>
                    <th>Druh chodu</th>
                    <th class="text-end">Hmotnost</th>
                    <th>Potravina</th>
                    <th class="text-end">Kalorie</th>
                    <th>Čas vytvoření</th>
                  </tr>
                </thead>
                <tbody id="data-table-body">
                </tbody>
              </table>
            </div>
            
            <!-- Stránkování -->
            <div class="pagination-container">
              <nav aria-label="Stránkování dat">
                <ul class="pagination justify-content-center mb-0" id="pagination">
                </ul>
              </nav>
            </div>
          </div>
          
          <!-- Prázdný stav -->
          <div id="empty-state" class="text-center p-5 d-none">
            <i class="bi bi-inbox display-1 text-muted mb-3"></i>
            <h4>Žádná data</h4>
            <p class="text-muted mb-4">
              Zkuste upravit filtry nebo počkejte na nové záznamy od klientů.
            </p>
            <button class="btn btn-outline-primary" id="clear-filters-empty-btn">
              <i class="bi bi-funnel me-2"></i>Vymazat všechny filtry
            </button>
          </div>
        </div>

        <!-- Nedávná aktivita -->
        <div class="row mt-4">
          <div class="col-lg-6">
            <div class="activity-section">
              <h5 class="mb-4">
                <i class="bi bi-activity me-2 text-primary"></i>
                Nedávná aktivita
              </h5>
              <div id="recent-activity">
                <!-- Zde se zobrazí nedávná aktivita -->
              </div>
            </div>
          </div>
          
          <div class="col-lg-6">
            <div class="activity-section">
              <h5 class="mb-4">
                <i class="bi bi-trophy me-2 text-warning"></i>
                Top klienti
              </h5>
              <div id="top-clients">
                <!-- Zde se zobrazí top klienti -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="loading-overlay d-none" id="loading-overlay">
    <div class="loading-content">
      <div class="spinner-border mb-3" role="status">
        <span class="visually-hidden">Zpracovávám...</span>
      </div>
      <h5>Zpracovávám požadavek...</h5>
      <p class="text-muted mb-0">Prosím počkejte</p>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===== KONFIGURACE =====
    const CONFIG = {
      API_URL: 'https://script.google.com/macros/s/AKfycbxwF7Sa4bvXsIb7nwfo6Fq2yPad_7CUXUJcHvDER7k_mp8YecFcbTOQXQyxQsVsDOWV/exec'
      AUTO_REFRESH_INTERVAL: 60000, // 60 sekund
      DEBUG: false
    };

    // ===== GLOBÁLNÍ PROMĚNNÉ =====
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let autoRefreshTimer = null;

    // ===== INICIALIZACE =====
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    function initializeApp() {
      setupEventListeners();
      setupDefaultDates();
      loadAllData();
      startAutoRefresh();
      
      if (CONFIG.DEBUG) {
        console.log('Admin panel inicializován');
      }
    }

    function setupEventListeners() {
      document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
      document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);
      document.getElementById('clear-filters-empty-btn').addEventListener('click', clearFilters);
      document.getElementById('refresh-btn').addEventListener('click', () => loadAllData(true));
      
      document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
      document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
      document.getElementById('generate-report-btn').addEventListener('click', generateReport);
    }

    function setupDefaultDates() {
      const today = new Date();
      const weekAgo = new Date(today);
      weekAgo.setDate(today.getDate() - 7);
      
      document.getElementById('filter-date-from').value = weekAgo.toISOString().split('T')[0];
      document.getElementById('filter-date-to').value = today.toISOString().split('T')[0];
    }

    async function loadAllData(showLoading = false) {
      try {
        if (showLoading) {
          document.getElementById('loading-overlay').classList.remove('d-none');
        }
        
        document.getElementById('loading').classList.remove('d-none');
        document.getElementById('data-container').classList.add('d-none');
        document.getElementById('empty-state').classList.add('d-none');
        
        if (CONFIG.DEBUG) {
          console.log('Načítám všechna data z API...');
        }

        const response = await fetch(`${CONFIG.API_URL}?admin=1`);
        
        if (!response.ok) {
          throw new Error(`HTTP chyba: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          allData = result.data || [];
          filteredData = [...allData];
          
          updateStatistics();
          updateClientFilter();
          displayData();
          updateRecentActivity();
          updateTopClients();
          
          if (CONFIG.DEBUG) {
            console.log(`Načteno ${allData.length} záznamů`);
          }
          
        } else {
          throw new Error(result.error || 'Neznámá chyba serveru');
        }

      } catch (error) {
        console.error('Chyba při načítání dat:', error);
        showError(`Chyba při načítání dat: ${error.message}`);
      } finally {
        document.getElementById('loading').classList.add('d-none');
        if (showLoading) {
          document.getElementById('loading-overlay').classList.add('d-none');
        }
      }
    }

    function updateStatistics() {
      const now = new Date();
      const thirtyDaysAgo = new Date(now);
      thirtyDaysAgo.setDate(now.getDate() - 30);
      
      const sevenDaysAgo = new Date(now);
      sevenDaysAgo.setDate(now.getDate() - 7);
      
      const today = now.toISOString().split('T')[0];

      // Aktivní klienti za 30 dní
      const activeClients = new Set(
        allData
          .filter(item => new Date(item.datum) >= thirtyDaysAgo)
          .map(item => item.klient_klic)
      ).size;

      // Dnešní záznamy
      const todayRecords = allData.filter(item => 
        item.datum.split('T')[0] === today
      ).length;

      // Průměr za posledních 7 dní
      const recentData = allData.filter(item => new Date(item.datum) >= sevenDaysAgo);
      const avgDaily = Math.round(recentData.length / 7);

      document.getElementById('total-clients').textContent = activeClients;
      document.getElementById('total-records').textContent = allData.length.toLocaleString();
      document.getElementById('today-records').textContent = todayRecords;
      document.getElementById('avg-daily').textContent = avgDaily;
    }

    function updateClientFilter() {
      const clientSelect = document.getElementById('filter-client');
      const currentValue = clientSelect.value;
      
      const clients = new Set(allData.map(item => item.klient_klic));
      
      clientSelect.innerHTML = '<option value="">Všichni klienti</option>';
      
      Array.from(clients).sort().forEach(client => {
        const option = document.createElement('option');
        option.value = client;
        option.textContent = client;
        if (client === currentValue) {
          option.selected = true;
        }
        clientSelect.appendChild(option);
      });
    }

    function applyFilters() {
      const client = document.getElementById('filter-client').value;
      const dateFrom = document.getElementById('filter-date-from').value;
      const dateTo = document.getElementById('filter-date-to').value;

      filteredData = allData.filter(item => {
        // Filtr podle klienta
        if (client && item.klient_klic !== client) return false;
        
        // Filtr podle data
        const itemDate = item.datum.split('T')[0];
        if (dateFrom && itemDate < dateFrom) return false;
        if (dateTo && itemDate > dateTo) return false;
        
        return true;
      });

      currentPage = 1;
      displayData();
      
      if (CONFIG.DEBUG) {
        console.log(`Filtrováno ${filteredData.length} z ${allData.length} záznamů`);
      }
    }

    function clearFilters() {
      document.getElementById('filter-client').value = '';
      document.getElementById('filter-date-from').value = '';
      document.getElementById('filter-date-to').value = '';
      
      filteredData = [...allData];
      currentPage = 1;
      displayData();
    }

    function displayData() {
      const recordsCount = document.getElementById('records-count');
      
      if (filteredData.length === 0) {
        document.getElementById('data-container').classList.add('d-none');
        document.getElementById('empty-state').classList.remove('d-none');
        recordsCount.textContent = '0 záznamů';
        return;
      }

      document.getElementById('data-container').classList.remove('d-none');
      document.getElementById('empty-state').classList.add('d-none');
      
      recordsCount.textContent = `${filteredData.length.toLocaleString()} záznamů`;
      
      displayTable();
      displayPagination();
    }

    function displayTable() {
      const tbody = document.getElementById('data-table-body');
      tbody.innerHTML = '';

      // Seřazení podle data a času (nejnovější první)
      const sortedData = [...filteredData].sort((a, b) => {
        const dateA = new Date(a.timestamp || a.datum);
        const dateB = new Date(b.timestamp || b.datum);
        return dateB - dateA;
      });

      // Stránkování
      const startIndex = (currentPage - 1) * CONFIG.ITEMS_PER_PAGE;
      const endIndex = startIndex + CONFIG.ITEMS_PER_PAGE;
      const pageData = sortedData.slice(startIndex, endIndex);

      pageData.forEach((item, index) => {
        const row = document.createElement('tr');
        row.style.animationDelay = `${index * 0.05}s`;
        
        row.innerHTML = `
          <td>
            <strong>${formatDate(item.datum)}</strong>
          </td>
          <td>
            <span class="client-badge badge">${item.klient_klic}</span>
          </td>
          <td>
            <span class="meal-badge badge">${item.druh_chodu}</span>
          </td>
          <td class="text-end">
            <strong>${parseFloat(item.hmotnost).toLocaleString()}</strong>
            <small class="text-muted">g/ml</small>
          </td>
          <td>
            <strong>${item.potravina}</strong>
          </td>
          <td class="text-end">
            <span class="badge bg-warning text-dark">
              ${Math.round(item.kaloricka_hodnota || 0)}
            </span>
            <small class="text-muted">kcal</small>
          </td>
          <td class="text-muted small">
            ${item.timestamp ? formatDateTime(item.timestamp) : '-'}
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function displayPagination() {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      
      const totalPages = Math.ceil(filteredData.length / CONFIG.ITEMS_PER_PAGE);
      
      if (totalPages <= 1) return;
      
      // Předchozí stránka
      if (currentPage > 1) {
        pagination.appendChild(createPaginationItem('«', currentPage - 1));
      }
      
      // Čísla stránek
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);
      
      if (startPage > 1) {
        pagination.appendChild(createPaginationItem('1', 1));
        if (startPage > 2) {
          pagination.appendChild(createPaginationItem('...', null, true));
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        pagination.appendChild(createPaginationItem(i, i, false, i === currentPage));
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          pagination.appendChild(createPaginationItem('...', null, true));
        }
        pagination.appendChild(createPaginationItem(totalPages, totalPages));
      }
      
      // Následující stránka
      if (currentPage < totalPages) {
        pagination.appendChild(createPaginationItem('»', currentPage + 1));
      }
    }

    function createPaginationItem(text, page, disabled = false, active = false) {
      const li = document.createElement('li');
      li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
      
      const a = document.createElement('a');
      a.className = 'page-link';
      a.href = '#';
      a.textContent = text;
      
      if (!disabled && page !== null) {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          currentPage = page;
          displayData();
        });
      }
      
      li.appendChild(a);
      return li;
    }

    function updateRecentActivity() {
      const container = document.getElementById('recent-activity');
      container.innerHTML = '';

      // Posledních 10 záznamů
      const recentData = [...allData]
        .sort((a, b) => new Date(b.timestamp || b.datum) - new Date(a.timestamp || a.datum))
        .slice(0, 10);

      if (recentData.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Žádná aktivita</p>';
        return;
      }

      recentData.forEach(item => {
        const activityItem = document.createElement('div');
        activityItem.className = 'activity-item';
        
        activityItem.innerHTML = `
          <div class="activity-icon">
            <i class="bi bi-plus"></i>
          </div>
          <div class="activity-content">
            <div>
              <strong>${item.klient_klic}</strong> přidal
              <strong>${item.potravina}</strong>
            </div>
            <div class="activity-time">
              ${item.druh_chodu} • ${item.hmotnost}g • ${item.kaloricka_hodnota || 0} kcal
              <br>
              <small>${formatTime(item.timestamp || item.datum)}</small>
            </div>
          </div>
        `;
        container.appendChild(activityItem);
      });
    }

    function updateTopClients() {
      const container = document.getElementById('top-clients');
      container.innerHTML = '';

      // Seskupení podle klientů
      const clientStats = {};
      allData.forEach(item => {
        if (!clientStats[item.klient_klic]) {
          clientStats[item.klient_klic] = { count: 0, calories: 0 };
        }
        clientStats[item.klient_klic].count++;
        clientStats[item.klient_klic].calories += parseFloat(item.kaloricka_hodnota) || 0;
      });

      // Seřazení podle počtu záznamů
      const topClients = Object.entries(clientStats)
        .sort(([,a], [,b]) => b.count - a.count)
        .slice(0, 5);

      if (topClients.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Žádní klienti</p>';
        return;
      }

      topClients.forEach(([client, stats], index) => {
        const clientItem = document.createElement('div');
        clientItem.className = 'activity-item';
        
        clientItem.innerHTML = `
          <div class="activity-icon">
            <strong>${index + 1}</strong>
          </div>
          <div class="activity-content">
            <div>
              <strong>${client}</strong>
            </div>
            <div class="activity-time">
              ${stats.count} záznamů • ${Math.round(stats.calories).toLocaleString()} kcal
            </div>
          </div>
        `;
        container.appendChild(clientItem);
      });
    }

    function exportToCSV() {
      if (filteredData.length === 0) {
        alert('Žádná data k exportu!');
        return;
      }

      const headers = ['Datum', 'Klient', 'Druh chodu', 'Hmotnost (g)', 'Potravina', 'Kalorie (kcal)', 'Časové razítko'];
      const csvContent = [
        headers.join(','),
        ...filteredData.map(item => [
          `"${item.datum}"`,
          `"${item.klient_klic}"`,
          `"${item.druh_chodu}"`,
          item.hmotnost,
          `"${item.potravina.replace(/"/g, '""')}"`,
          item.kaloricka_hodnota || 0,
          `"${item.timestamp || ''}"`
        ].join(','))
      ].join('\n');

      const filename = `stravovaci_denik_${new Date().toISOString().split('T')[0]}.csv`;
      downloadFile(csvContent, filename, 'text/csv;charset=utf-8;');
    }

    function exportToExcel() {
      // Pro jednoduchost exportujeme jako CSV s .xlsx příponou
      exportToCSV();
    }

    function generateReport() {
      if (filteredData.length === 0) {
        alert('Žádná data k vytvoření přehledu!');
        return;
      }

      const stats = generateDetailedStats();
      const reportContent = createReportHTML(stats);

      const newWindow = window.open('', '_blank');
      newWindow.document.write(reportContent);
      newWindow.document.close();
    }

    function generateDetailedStats() {
      const clientStats = {};
      const mealStats = {};
      let totalCalories = 0;

      filteredData.forEach(item => {
        // Statistiky klientů
        if (!clientStats[item.klient_klic]) {
          clientStats[item.klient_klic] = { count: 0, calories: 0 };
        }
        clientStats[item.klient_klic].count++;
        clientStats[item.klient_klic].calories += parseFloat(item.kaloricka_hodnota) || 0;

        // Statistiky chodu jídla
        if (!mealStats[item.druh_chodu]) {
          mealStats[item.druh_chodu] = { count: 0, calories: 0 };
        }
        mealStats[item.druh_chodu].count++;
        mealStats[item.druh_chodu].calories += parseFloat(item.kaloricka_hodnota) || 0;

        totalCalories += parseFloat(item.kaloricka_hodnota) || 0;
      });

      return { clientStats, mealStats, totalCalories };
    }

    function createReportHTML(stats) {
      const fromDate = document.getElementById('filter-date-from').value;
      const toDate = document.getElementById('filter-date-to').value;
      const client = document.getElementById('filter-client').value;
      
      return `
        <!DOCTYPE html>
        <html lang="cs">
        <head>
          <meta charset="UTF-8">
          <title>Přehled stravování</title>
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
          <style>
            body { font-family: 'Segoe UI', sans-serif; }
            .header { background: linear-gradient(135deg, #dc3545, #fd7e14); color: white; padding: 2rem 0; }
            .stat-box { background: #f8f9fa; border-left: 4px solid #dc3545; padding: 1rem; margin: 1rem 0; }
          </style>
        </head>
        <body>
          <div class="header text-center">
            <div class="container">
              <h1>Přehled stravování</h1>
              <p>Vygenerováno: ${new Date().toLocaleString('cs-CZ')}</p>
            </div>
          </div>
          
          <div class="container my-5">
            <div class="row">
              <div class="col-md-8">
                <h2>Filtrované období</h2>
                <div class="stat-box">
                  <strong>Klient:</strong> ${client || 'Všichni klienti'}<br>
                  <strong>Od:</strong> ${fromDate || 'Neomezeno'}<br>
                  <strong>Do:</strong> ${toDate || 'Neomezeno'}<br>
                  <strong>Celkem záznamů:</strong> ${filteredData.length.toLocaleString()}<br>
                  <strong>Celkem kalorií:</strong> ${Math.round(stats.totalCalories).toLocaleString()} kcal
                </div>
                
                <h3>Top klienti podle počtu záznamů</h3>
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Klient</th>
                      <th>Počet záznamů</th>
                      <th>Celkem kalorií</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${Object.entries(stats.clientStats)
                      .sort(([,a], [,b]) => b.count - a.count)
                      .slice(0, 10)
                      .map(([client, data]) => `
                        <tr>
                          <td>${client}</td>
                          <td>${data.count}</td>
                          <td>${Math.round(data.calories).toLocaleString()}</td>
                        </tr>
                      `).join('')}
                  </tbody>
                </table>
                
                <h3>Statistiky podle chodu jídla</h3>
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Chod jídla</th>
                      <th>Počet záznamů</th>
                      <th>Celkem kalorií</th>
                      <th>Podíl (%)</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${Object.entries(stats.mealStats)
                      .sort(([,a], [,b]) => b.calories - a.calories)
                      .map(([meal, data]) => {
                        const percentage = stats.totalCalories > 0 ? (data.calories / stats.totalCalories * 100) : 0;
                        return `
                          <tr>
                            <td>${meal}</td>
                            <td>${data.count}</td>
                            <td>${Math.round(data.calories).toLocaleString()}</td>
                            <td>${Math.round(percentage)}%</td>
                          </tr>
                        `;
                      }).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </body>
        </html>
      `;
    }

    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function startAutoRefresh() {
      if (CONFIG.AUTO_REFRESH_INTERVAL > 0) {
        autoRefreshTimer = setInterval(() => {
          loadAllData(false);
        }, CONFIG.AUTO_REFRESH_INTERVAL);
      }
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString + 'T00:00:00');
      return date.toLocaleDateString('cs-CZ');
    }

    function formatDateTime(datetimeString) {
      if (!datetimeString) return '';
      const date = new Date(datetimeString);
      return date.toLocaleString('cs-CZ');
    }

    function formatTime(datetimeString) {
      if (!datetimeString) return '';
      const date = new Date(datetimeString);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'právě teď';
      if (diff < 3600000) return `před ${Math.floor(diff / 60000)} min`;
      if (diff < 86400000) return `před ${Math.floor(diff / 3600000)} h`;
      return date.toLocaleDateString('cs-CZ');
    }

    function showError(message) {
      const alert = document.createElement('div');
      alert.className = 'alert alert-danger alert-dismissible fade show';
      alert.innerHTML = `
        <i class="bi bi-exclamation-triangle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.querySelector('.main-content .container-fluid').insertBefore(
        alert, 
        document.querySelector('.stats-overview')
      );
    }

    // Cleanup při opuštění stránky
    window.addEventListener('beforeunload', () => {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
      }
    });

    // ===== VALIDACE API URL =====
    if (CONFIG.API_URL === 'https://script.google.com/macros/s/AKfycby_EAwyBCmVhRsO59AEeS6ybRPCkXeHXHBhL3t4CgpOH46LnQA2806dvc-mpnLgawbQ/exec') {
      document.addEventListener('DOMContentLoaded', function() {
        showError('⚠️ Aplikace není nakonfigurována! Prosím nastavte API_URL v kódu.');
      });
    }
  </script>
</body>
</html>
